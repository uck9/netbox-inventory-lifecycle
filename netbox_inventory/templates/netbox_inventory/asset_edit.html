{% extends 'generic/object_edit.html' %}
{% load static %}
{% load form_helpers %}
{% load helpers %}
{% load i18n %}

{% block tabs %}
  {% include 'netbox_inventory/inc/asset_edit_header.html' with active_tab='add' %}
{% endblock tabs %}

{% block form %}
     <div class="field-group mb-5">
        <div class="row">
          <h2 class="col-9 offset-3">General</h2>
        </div>
        {% render_field form.name %}
        {% render_field form.asset_tag %}
        {% render_field form.description %}
        {% render_field form.tags %}
        {% render_field form.status %}
        {% render_field form.allocation_status %}
    </div>

    <div class="field-group mb-5">
        <div class="row mb-2">
          <h2 class="col-9 offset-3">Hardware</h2>
        </div>
        {% render_field form.serial %}
        {% render_field form.vendor_instance_id %}
        {% render_field form.manufacturer %}
        <div class="row">
          <div class="col-9 offset-3">
          <ul class="nav nav-pills mb-1" role="tablist">
            <li role="presentation" class="nav-item">
                <a class="nav-link{% if form.initial.device_type or form.no_hardware_type %} active{% endif %}" href="#device_type" role="tab" data-bs-toggle="tab">Device</a>
              </li>
            <li role="presentation" class="nav-item">
                <a class="nav-link{% if form.initial.module_type %} active{% endif %}" href="#module_type" role="tab" data-bs-toggle="tab">Module</a>
              </li>
            <li role="presentation" class="nav-item">
                <a class="nav-link{% if form.initial.inventoryitem_type %} active{% endif %}" href="#inventoryitem_type" role="tab" data-bs-toggle="tab">Inventory Item</a>
              </li>
            <li role="presentation" class="nav-item">
                <a class="nav-link{% if form.initial.rack_type %} active{% endif %}" href="#rack_type" role="tab" data-bs-toggle="tab">Rack</a>
              </li>
          </ul>
          </div>
        </div>
        <div class="tab-content p-0 border-0">
          <div class="tab-pane{% if form.initial.device_type or form.no_hardware_type %} active{% endif %}" id="device_type">
            {% render_field form.device_type %}
          </div>
          <div class="tab-pane{% if form.initial.module_type %} active{% endif %}" id="module_type">
            {% render_field form.module_type %}
          </div>
          <div class="tab-pane{% if form.initial.inventoryitem_type %} active{% endif %}" id="inventoryitem_type">
            {% render_field form.inventoryitem_type %}
          </div>
          <div class="tab-pane{% if form.initial.rack_type %} active{% endif %}" id="rack_type">
            {% render_field form.rack_type %}
          </div>
        </div>
    </div>

    <div class="field-group my-5">
        <div class="row">
          <h2 class="col-9 offset-3">Purchase</h2>
        </div>
        {% render_field form.owning_tenant %}
        {% render_field form.purchase %}
        {% render_field form.order %}
        {% render_field form.base_license_sku %}
    </div>

    <div class="field-group my-5">
        <div class="row mb-2">
          <h2 class="col-9 offset-3">Key Hardware Dates</h2>
        </div>
        {% render_field form.vendor_ship_date %}
        {% render_field form.warranty_start %}
        {% render_field form.warranty_end %}
    </div>

    <div class="field-group my-5">
        <div class="row mb-2">
          <h2 class="col-9 offset-3">Support Status</h2>
        </div>
        {% render_field form.support_state %}
        {% render_field form.support_reason %}
        {% render_field form.support_source %}
        {% render_field form.support_validated_at %}
    </div>

    <div class="field-group my-5">
        <div class="row mb-2">
          <h2 class="col-9 offset-3">Assigned to</h2>
        </div>
        {% render_field form.tenant %}
        {% render_field form.contact_group %}
        {% render_field form.contact %}
    </div>

    <div class="field-group mb-5">
        <div class="row">
          <h2 class="col-9 offset-3">Location</h2>
        </div>
        {# Only meaningful for OT / manusal install site for assets that are used+allocated without hardware assigned #}
        {% render_field form.installed_site_override %}
        {% render_field form.storage_site %}
        {% render_field form.storage_location %}  
    </div>

    {% if form.custom_fields %}
        <div class="field-group mb-5">
            <div class="row">
              <h5 class="col-9 offset-3">Custom Fields</h5>
            </div>
            {% render_custom_fields form %}
        </div>
    {% endif %}

    {% if form.owner %}
        <div class="field-group mb-5">
            <div class="row">
                <h2 class="col-9 offset-3">{% trans "Ownership" %}</h2>
            </div>
            {% render_field form.owner %}
        </div>
    {% endif %}

    {% if form.comments %}
        <div class="field-group mb-5">
            {% render_field form.comments %}
        </div>
    {% endif %}

{% endblock %}

{% block javascript %}
  {{ block.super }}
  <script>
    function getEl(id) {
      return document.getElementById(id);
    }

    function getVal(id) {
      const el = getEl(id);
      return el ? el.value : "";
    }

    function setVisibleById(id, visible) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = visible ? "" : "none";
}

    function setVisibleForField(fieldId, visible) {
      const el = getEl(fieldId);
      if (!el) return;

      const row = el.closest(".mb-3") || el.closest(".form-group");
      if (!row) return;

      row.style.display = visible ? "" : "none";
    }

    function clearField(fieldId) {
      const el = getEl(fieldId);
      if (!el) return;
      el.value = "";
      // Trigger change so DynamicModelChoiceField dependencies update if needed
      el.dispatchEvent(new Event("change", { bubbles: true }));
    }

    function toggleAssetLocationUX() {
      const status = getVal("id_status");
      const allocation = getVal("id_allocation_status");

      // Assigned hardware fields (may not exist on the form, hence safe reads)
      const device = getVal("id_device");
      const module = getVal("id_module");
      const inventoryitem = getVal("id_inventoryitem");
      const rack = getVal("id_rack");
      const hasAssignedHardware = Boolean(device || module || inventoryitem || rack);

      // ----- Storage fields UX -----
      const showStorage = (status === "stored");

      setVisibleForField("id_storage_site", showStorage);
      setVisibleForField("id_storage_location", showStorage);

      // Enforce UX: if not stored, clear storage fields to avoid stale data
      if (!showStorage) {
        // storage_site is derived from storage_location in your form setup, so just clear location
        if (getEl("id_storage_location") && getVal("id_storage_location")) {
          clearField("id_storage_location");
        }
      } else {
        // Optional UX enforcement: mark storage_location as required in the browser UI
        const locEl = getEl("id_storage_location");
        if (locEl) locEl.required = true;
      }

      // If not stored, remove browser-required flag
      if (!showStorage) {
        const locEl = getEl("id_storage_location");
        if (locEl) locEl.required = false;
      }

      // ----- Installed Site Override UX -----
      const showOverride = (
        status === "used" &&
        allocation === "allocated" &&
        !hasAssignedHardware
      );

      // ----- Location group visibility -----
      // Show the whole section if ANY location-related field is relevant
      const showLocationGroup = showStorage || showOverride;
      setVisibleById("asset-location-group", showLocationGroup);


      setVisibleForField("id_installed_site_override", showOverride);

      // Clear override when it doesn't apply
      if (!showOverride) {
        if (getEl("id_installed_site_override") && getVal("id_installed_site_override")) {
          clearField("id_installed_site_override");
        }
      }
    }

    document.addEventListener("DOMContentLoaded", toggleAssetLocationUX);

    // Re-evaluate whenever key fields change
    [
      "id_status",
      "id_allocation_status",
      "id_device",
      "id_module",
      "id_inventoryitem",
      "id_rack",
      "id_storage_location",
      "id_installed_site_override",
    ].forEach((id) => {
      const el = getEl(id);
      if (el) el.addEventListener("change", toggleAssetLocationUX);
    });
  </script>
{% endblock %}
